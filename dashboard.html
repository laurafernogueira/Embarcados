<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel de Gest√£o de Risco</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f9; color: #333; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .status-badge { font-size: 2.2em; font-weight: 800; padding: 15px; border-radius: 8px; margin: 15px 0; color: white; display: block; }
        .SEGURO { background-color: #2ecc71; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .MODERADO { background-color: #f39c12; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .ARRISCADO { background-color: #e74c3c; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .OFFLINE { background-color: #95a5a6; }

        .metric-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .metric-label { font-size: 0.8em; color: #7f8c8d; text-transform: uppercase; }
        .metric-value { font-size: 1.3em; font-weight: bold; color: #2c3e50; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üõ°Ô∏è Sistema de Telemetria com IA</h1>
        <p>Monitoramento de Risco em Tempo Real - Algoritmo XGBoost</p>
    </div>

    <div class="grid">
        <div class="card" style="text-align: center;">
            <h3 id="driver-name">Identificando Condutor...</h3>
            <div id="risk-status" class="status-badge OFFLINE">AGUARDANDO</div>
            
            <div class="metric-grid">
                <div><span class="metric-label">Velocidade</span><span id="txt-vel" class="metric-value">0</span><small>km/h</small></div>
                <div><span class="metric-label">RPM</span><span id="txt-rpm" class="metric-value">0</span></div>
                <div><span class="metric-label">Acelera√ß√£o</span><span id="txt-acel" class="metric-value">0</span><small>m/s¬≤</small></div>
            </div>
        </div>

        <div class="card">
            <h3>Hist√≥rico de Velocidade</h3>
            <canvas id="velocityChart" height="200"></canvas>
        </div>
    </div>
</div>

<script>
    let chart;
    const ctx = document.getElementById('velocityChart').getContext('2d');

    function initChart() {
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Velocidade Real', data: [], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 180 } } }
        });
    }

    async function updateDashboard() {
        try {
            // Chamada relativa: funciona em qualquer dom√≠nio/link
            const response = await fetch('/api/dados-recentes');
            const result = await response.json();
            
            if (result.dados && result.dados.length > 0) {
                const latest = result.dados[0];
                
                // Atualiza Identidade e Risco
                document.getElementById('driver-name').innerText = latest.motorista_id || "Motorista Desconhecido";
                
                const mlClass = latest.classificacao.classificacao_ml.toUpperCase();
                const badge = document.getElementById('risk-status');
                badge.innerText = mlClass;
                badge.className = 'status-badge ' + mlClass;

                // Atualiza M√©tricas (Dados aninhados da Raspberry)
                document.getElementById('txt-vel').innerText = latest.dados.velocidade;
                document.getElementById('txt-rpm').innerText = latest.dados.rpm;
                document.getElementById('txt-acel').innerText = latest.dados.aceleracao_ms2;

                // Atualiza Gr√°fico (Invertendo a ordem para o tempo fluir corretamente)
                const history = [...result.dados].reverse();
                chart.data.labels = history.map(d => new Date(d.timestamp).toLocaleTimeString());
                chart.data.datasets[0].data = history.map(d => d.dados.velocidade);
                chart.update('none');
            }
        } catch (error) {
            console.error("Erro ao sincronizar dashboard:", error);
        }
    }

    initChart();
    // Atualiza√ß√£o a cada 2 segundos para sincronia perfeita com a Raspberry
    setInterval(updateDashboard, 2000);
</script>

</body>
</html>
