<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Monitoramento de Risco - Seguradora</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; padding: 20px; color: #333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: auto; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        .risk-badge { font-size: 2em; font-weight: 800; padding: 10px 20px; border-radius: 10px; display: inline-block; margin-top: 10px; }
        .ARRISCADO { color: #fff; background: #e74c3c; }
        .MODERADO { color: #fff; background: #f39c12; }
        .SEGURO { color: #fff; background: #2ecc71; }
        .driver-info { font-size: 1.5em; color: #1a73e8; margin-bottom: 5px; }
        .stats-box { display: flex; justify-content: space-around; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 40px; }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Painel de Gest√£o de Risco - Telemetria</h1>
    
    <div class="grid">
        <div class="card">
            <h2>üë§ Identifica√ß√£o do Condutor</h2>
            <div id="motorista-id" class="driver-info">Buscando...</div>
            <div id="status-risco" class="risk-badge">AGUARDANDO</div>
            
            <div class="stats-box">
                <div><strong>Velocidade</strong><br><span id="val-vel">0</span> km/h</div>
                <div><strong>RPM</strong><br><span id="val-rpm">0</span></div>
                <div><strong>Acelera√ß√£o</strong><br><span id="val-acel">0</span> m/s¬≤</div>
            </div>
        </div>

        <div class="card">
            <h2>üìà Gr√°fico de Velocidade Real</h2>
            <canvas id="graficoVelocidade"></canvas>
        </div>
    </div>

    <script>
        const API_URL = "/api/dados-recentes";
        let grafico;

        function inicializarGrafico() {
            const ctx = document.getElementById('graficoVelocidade').getContext('2d');
            grafico = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'km/h', data: [], borderColor: '#1a73e8', fill: true, backgroundColor: 'rgba(26,115,232,0.1)', tension: 0.4 }] }
            });
        }

        async function atualizar() {
            try {
                const response = await fetch(API_URL);
                const json = await response.json();
                if (json.dados && json.dados.length > 0) {
                    const ultimo = json.dados[0];
                    const classificacao = ultimo.classificacao.classificacao_ml.toUpperCase();
                    
                    // Atualiza Motorista e Risco
                    document.getElementById('motorista-id').innerText = `Motorista: ${ultimo.motorista_id}`;
                    const elRisco = document.getElementById('status-risco');
                    elRisco.innerText = classificacao;
                    elRisco.className = `risk-badge ${classificacao}`;

                    // Atualiza Dados Secund√°rios
                    document.getElementById('val-vel').innerText = ultimo.dados.velocidade;
                    document.getElementById('val-rpm').innerText = ultimo.dados.rpm;
                    document.getElementById('val-acel').innerText = ultimo.dados.aceleracao_ms2;

                    // Atualiza Gr√°fico
                    const historico = [...json.dados].reverse();
                    grafico.data.labels = historico.map(d => new Date(d.timestamp).toLocaleTimeString());
                    grafico.data.datasets[0].data = historico.map(d => d.dados.velocidade);
                    grafico.update();
                }
            } catch (e) { console.error("Falha ao buscar dados", e); }
        }

        window.onload = () => { inicializarGrafico(); atualizar(); setInterval(atualizar, 3000); };
    </script>
</body>
</html>
